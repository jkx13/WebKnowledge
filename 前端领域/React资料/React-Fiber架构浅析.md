## 1.1 æ¸²æŸ“å¸§
å¸§ (frame): åŠ¨ç”»è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€å¹…é™æ­¢çš„ç”»é¢å«åšå¸§ã€‚

å¸§ç‡ (frame per second): å³æ¯ç§’é’Ÿæ’­æ”¾çš„é™æ­¢ç”»é¢çš„æ•°é‡ã€‚

å¸§æ—¶é•¿ (frame running time): æ¯ä¸€å¹…é™æ­¢çš„ç”»é¢çš„åœç•™æ—¶é—´ã€‚

ä¸¢å¸§ (dropped frame): å½“æŸä¸€å¸§æ—¶é•¿é«˜äºå¹³å‡å¸§æ—¶é•¿ã€‚
- ä¸€èˆ¬æ¥è¯´æµè§ˆå™¨åˆ·æ–°ç‡åœ¨60Hz, æ¸²æŸ“ä¸€å¸§æ—¶é•¿å¿…é¡»æ§åˆ¶åœ¨16.67ms (1s / 60 = 16.67ms)ã€‚
- å¦‚æœæ¸²æŸ“è¶…è¿‡è¯¥æ—¶é—´, å¯¹ç”¨æˆ·è§†è§‰ä¸Šæ¥è¯´ï¼Œä¼šå‡ºç°å¡é¡¿ç°è±¡ï¼Œå³ä¸¢å¸§ (dropped frame)ã€‚

## 1.2 å¸§ç”Ÿå‘½å‘¨æœŸ
![ç”Ÿå‘½å‘¨æœŸ](./image/render.png)

```
ç®€å•æè¿°ä¸€å¸§çš„ç”Ÿå‘½å‘¨æœŸ:

1. ä¸€å¸§å¼€å§‹ã€‚

2. ä¸»çº¿ç¨‹:

- Event Handlers: UIäº¤äº’è¾“å…¥çš„äº‹ä»¶å›è°ƒ, ä¾‹å¦‚inputã€clickã€wheelç­‰ã€‚

- RAF: æ‰§è¡ŒrequestAnimationFrameå›è°ƒã€‚

- DOM Tree: è§£æHTML, æ„å»ºDOM Tree, å½“JSå¯¹DOMæœ‰å˜æ›´ä¼šé‡æ–°è§¦å‘è¯¥æµç¨‹ã€‚

- CSS Tree: æ„å»ºCSS Treeã€‚è‡³æ­¤æ„å»ºå‡ºRender Treeã€‚

- Layout: æ‰€æœ‰å…ƒç´ çš„positionã€sizeä¿¡æ¯ã€‚

- Paint: åƒç´ å¡«å……, ä¾‹å¦‚é¢œè‰²ã€æ–‡å­—ã€è¾¹æ¡†ç­‰å¯è§†éƒ¨åˆ†ã€‚

- Composite: ç»˜åˆ¶çš„æŒ‡ä»¤ä¿¡æ¯ä¼ åˆ°åˆæˆçº¿ç¨‹ä¸­ã€‚

- RequestIdleCallback: å¦‚æœæ­¤æ—¶ä¸€å¸§è¿˜æœ‰ç©ºä½™æ—¶é—´, åˆ™æ‰§è¡Œè¯¥å›è°ƒã€‚

3. åˆæˆçº¿ç¨‹:

- Raster: åˆæˆçº¿ç¨‹å°†ä¿¡æ¯åˆ†å—, å¹¶æŠŠæ¯å—å‘é€ç»™å…‰æ …çº¿ç¨‹, å…‰æ …çº¿ç¨‹åˆ›å»ºä½å›¾, å¹¶é€šçŸ¥GPUè¿›ç¨‹åˆ·æ–°è¿™ä¸€å¸§ã€‚

4. ä¸€å¸§ç»“æŸã€‚
```

## 1.3 ä¸¢å¸§å®éªŒ
æ€ä¹ˆå°±ä¸¢å¸§äº†å‘¢?
å¯¹äºæµç•…çš„åŠ¨ç”»ï¼Œå¦‚æœä¸€å¸§å¤„ç†æ—¶é—´è¶…è¿‡16msï¼Œå°±èƒ½æ„Ÿåˆ°é¡µé¢çš„å¡é¡¿äº†ã€‚

å½“ç”¨æˆ·ç‚¹å‡»ä»»ä¸€æŒ‰é”® Aï¼ŒBï¼ŒCï¼Œå› ä¸ºä¸»çº¿ç¨‹æ‰§è¡ŒEvent Handlersä»»åŠ¡ï¼ŒåŠ¨ç”»å› ä¸ºæµè§ˆå™¨ä¸èƒ½åŠæ—¶å¤„ç†ä¸‹ä¸€å¸§ï¼Œå¯¼è‡´åŠ¨ç”»å‡ºç°å¡é¡¿çš„ç°è±¡ã€‚

```
// å¤„ç†åŒæ­¥ä»»åŠ¡ï¼Œå¹¶å ç”¨ä¸»çº¿ç¨‹

const bindClick = id => 

  element(id).addEventListener('click', Work.onSyncUnit)

// ç»‘å®šclickäº‹ä»¶

bindClick('btnA')

bindClick('btnB')

bindClick('btnC')



var Work = {

   // æœ‰1ä¸‡ä¸ªä»»åŠ¡

   unit: 10000,

   // å¤„ç†æ¯ä¸ªä»»åŠ¡

   onOneUnit: function () {  for (var i = 0; i <= 500000; i++) {} },

   // åŒæ­¥å¤„ç†: ä¸€æ¬¡å¤„ç†å®Œæ‰€æœ‰ä»»åŠ¡

   onSyncUnit: function () {

      let _u = 0

      while (_u < Work.unit) {

         Work.onOneUnit()

         _u ++

      }

    }

 }
```

é€šè¿‡Chrome DevTool ä¸­ Performanceä¸­å¯æŸ¥çœ‹

## 1.4 è§£å†³ä¸¢å¸§
ä¸Šè¿°ï¼Œæˆ‘ä»¬å‘ç° JSè¿ç®—æ˜¯å ç”¨æ¸²æŸ“çš„æ—¶é—´çš„ã€‚

åœ¨è¿ç»­åŠ¨ç”»ä¸­ï¼Œè¦åšé«˜è€—æ—¶çš„æ“ä½œï¼Œå¦‚ä½•ä¿è¯å¸§å¹³ç¨³å‘¢ï¼Ÿ

**è§£å†³ä¸¢å¸§æ€è€ƒå¦‚ä¸‹:**
1. ä¸€å¸§ç©ºé—²æ—¶å¤„ç†, åˆ©ç”¨ RequestIdleCallback[4] å¤„ç†ä»»åŠ¡ã€‚
>window.requestIdleCallback()æ–¹æ³•å°†åœ¨æµè§ˆå™¨çš„ç©ºé—²æ—¶æ®µå†…è°ƒç”¨çš„å‡½æ•°æ’é˜Ÿã€‚è¿™ä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œåå°å’Œä½ä¼˜å…ˆçº§å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“å»¶è¿Ÿå…³é”®äº‹ä»¶ï¼Œå¦‚åŠ¨ç”»å’Œè¾“å…¥å“åº”ã€‚å‡½æ•°ä¸€èˆ¬ä¼šæŒ‰å…ˆè¿›å…ˆè°ƒç”¨çš„é¡ºåºæ‰§è¡Œï¼Œç„¶è€Œï¼Œå¦‚æœå›è°ƒå‡½æ•°æŒ‡å®šäº†æ‰§è¡Œè¶…æ—¶æ—¶é—´timeoutï¼Œåˆ™æœ‰å¯èƒ½ä¸ºäº†åœ¨è¶…æ—¶å‰æ‰§è¡Œå‡½æ•°è€Œæ‰“ä¹±æ‰§è¡Œé¡ºåºã€‚

2. å¯¹é«˜è€—æ—¶çš„ä»»åŠ¡ï¼Œè¿›è¡Œåˆ†æ­¥éª¤å¤„ç†ï¼ˆæˆ–Web workerï¼‰ã€‚
å°†ä¸€ä¸ªé«˜è€—æ—¶jsä»»åŠ¡åˆ†ä¸º å¤šä¸ªå­jsä»»åŠ¡ï¼Œåœ¨reqestIdleCallbackä¸­è°ƒç”¨

```
const bindClick = id => 

  element(id).addEventListener('click', Work.onAsyncUnit)

// ç»‘å®šclickäº‹ä»¶

bindClick('btnA')

bindClick('btnB')

bindClick('btnC')



var Work = {

    // æœ‰1ä¸‡ä¸ªä»»åŠ¡

    unit: 10000,

    // å¤„ç†æ¯ä¸ªä»»åŠ¡

    onOneUnit: function () {  for (var i = 0; i <= 500000; i++) {} },

    // å¼‚æ­¥å¤„ç†

    onAsyncUnit: function () {

        // ç©ºé—²æ—¶é—´ 1ms

        const FREE_TIME = 1

        let _u = 0



        function cb(deadline) {

            // å½“ä»»åŠ¡è¿˜æ²¡æœ‰è¢«å¤„ç†å®Œ & ä¸€å¸§è¿˜æœ‰çš„ç©ºé—²æ—¶é—´ > 1ms

            while (_u < Work.unit && deadline.timeRemaining() > FREE_TIME) {

                Work.onOneUnit()

                _u ++

            }

            // ä»»åŠ¡å¹²å®Œ, æ‰§è¡Œå›è°ƒ

            if (_u >= Work.unit) {

                // æ‰§è¡Œå›è°ƒ

                return

            }

            // ä»»åŠ¡æ²¡å®Œæˆ, ç»§ç»­ç­‰ç©ºé—²æ‰§è¡Œ

            window.requestIdleCallback(cb)

        }

        window.requestIdleCallback(cb)

    }

}
```

requestIdleCallback å¯å‘
å°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†å‰²æˆNä¸ªå°ä»»åŠ¡ï¼Œåœ¨æ¯ä¸€å¸§æœ‰ç©ºä½™æ—¶é—´æƒ…å†µä¸‹ï¼Œé€æ­¥å»æ‰§è¡Œå°ä»»åŠ¡ã€‚

## 2.React15 (-) æ¶æ„ç¼ºç‚¹
é€’å½’ Recursion: åˆ©ç”¨ è°ƒç”¨æ ˆ[9]ï¼Œå®ç°è‡ªå·±è°ƒç”¨è‡ªå·±çš„æ–¹æ³•ã€‚
## 2.1 æ¦‚è¿°åŸå› 
![](./image/fieber.png)

## 2.2 æµç¨‹å’Œä»£ç è§£æ
å¯èƒ½éœ€è¦ä½ æœ‰ç‚¹ æ·±åº¦ä¼˜å…ˆéå†ã€é€’å½’ã€å›æº¯æ€æƒ³ã€ğŸŒ² ç­‰æ•°æ®ç»“æ„çš„çŸ¥è¯†ã€‚

[](https://mp.weixin.qq.com/s/GDYfwQyIKOjqfC_n-oDPzQ)
